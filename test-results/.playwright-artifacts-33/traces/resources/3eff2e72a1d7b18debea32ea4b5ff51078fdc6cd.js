define(["react","big.js","mendix/filters/builders"],(function(e,t,n){"use strict";function a(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var l,r=a(t),i={exports:{}};
/*!
  	Copyright (c) 2018 Jed Watson.
  	Licensed under the MIT License (MIT), see
  	http://jedwatson.github.io/classnames
  */
l=i,function(){var e={}.hasOwnProperty;function t(){for(var n=[],a=0;a<arguments.length;a++){var l=arguments[a];if(l){var r=typeof l;if("string"===r||"number"===r)n.push(l);else if(Array.isArray(l)){if(l.length){var i=t.apply(null,l);i&&n.push(i)}}else if("object"===r){if(l.toString!==Object.prototype.toString&&!l.toString.toString().includes("[native code]")){n.push(l.toString());continue}for(var s in l)e.call(l,s)&&l[s]&&n.push(s)}}}return n.join(" ")}l.exports?(t.default=t,l.exports=t):window.classNames=t}();var s=i.exports;function u(t,n){const[a,l]=e.useState(),r=e.useCallback((()=>{l((e=>{const n=null==t?void 0:t.getBoundingClientRect();return l=n,(a=e)&&l&&a.height===l.height&&a.width===l.width&&a.bottom===l.bottom&&a.top===l.top&&a.left===l.left&&a.right===l.right?e:n;var a,l}))}),[t]);var i;return i=n?r:void 0,e.useEffect((()=>i?function(e){let t;const n=()=>{t=window.requestAnimationFrame((()=>{e(),n()}))},a=()=>window.cancelAnimationFrame(t);return n(),a}(i):void 0),[i]),a}function o(t){const n=t.defaultFilter,a=t.onChange,[l,r]=e.useState(n),[i,o]=e.useState(!1),c=e.useRef(null),d=e.useRef(null);var h,f;h=[c,d],f=()=>o(!1),e.useEffect((()=>{const e=e=>{if(Array.isArray(h)){if(h.some((t=>!t.current||t.current.contains(e.target))))return}else if(!h.current||h.current.contains(e.target))return;f()};return document.addEventListener("mousedown",e),document.addEventListener("touchstart",e),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("touchstart",e)}}),[h,f]);const p=u(c.current,i),v=e.useCallback((e=>{r(e),a(e),o(!1)}),[a]);e.useEffect((()=>{r(n),a(n)}),[n,a]);const m=e.createElement("ul",{ref:d,id:"".concat(t.id,"-filter-selectors"),className:"filter-selectors",role:"menu","data-focusindex":0,style:{position:"fixed",top:null==p?void 0:p.bottom,left:null==p?void 0:p.left}},t.options.map(((n,a)=>e.createElement("li",{className:s({"filter-selected":l===n.value}),key:a,onClick:e=>{e.preventDefault(),e.stopPropagation(),v(n.value)},onKeyDown:e=>{if("Enter"===e.key||" "===e.key)e.preventDefault(),e.stopPropagation(),v(n.value);else if("Tab"===e.key&&a+1===t.options.length)e.preventDefault(),v(l);else if("Tab"===e.key&&e.shiftKey&&0===a||"Escape"===e.key){var r;e.preventDefault(),null===(r=c.current)||void 0===r||null===(r=r.querySelector("button"))||void 0===r||r.focus(),o(!1)}},role:"menuitem",tabIndex:0},e.createElement("div",{className:s("filter-icon",n.value),"aria-hidden":!0}),e.createElement("div",{className:"filter-label"},n.label))))),g=e.useCallback((()=>{o((e=>!e)),setTimeout((()=>{var e;null===(e=d.current)||void 0===e||null===(e=e.querySelector("li.filter-selected"))||void 0===e||e.focus()}),10)}),[]);return e.createElement("div",{className:"filter-selector"},e.createElement("div",{className:"filter-selector-content",ref:c},e.createElement("button",{"aria-controls":"".concat(t.id,"-filter-selectors"),"aria-expanded":i,"aria-haspopup":!0,"aria-label":t.ariaLabel,className:s("btn btn-default filter-selector-button button-icon",l),onClick:g,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),e.stopPropagation(),g())}},"Â "),i&&m))}const c=e.memo((function(t){var n;const{current:a}=e.useRef(t.defaultFilter);return e.createElement("div",{className:s("filter-container",t.className),"data-focusindex":null!==(n=t.tabIndex)&&void 0!==n?n:0,style:t.styles},t.adjustable&&e.createElement(o,{ariaLabel:t.screenReaderButtonCaption,id:t.id,defaultFilter:a,onChange:t.onFilterChange,options:t.filters}),e.createElement("input",{"aria-label":t.screenReaderInputCaption,className:s("form-control",{"filter-input":t.adjustable}),disabled:t.inputDisabled,onChange:t.onInputChange,placeholder:t.placeholder,ref:t.inputRef,type:t.inputType,value:t.inputValue}))})),d=Object.freeze({reset:{value:"reset.value",filters:"reset.filters"}});function h(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var a=n.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}let f=()=>({emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),a=1;a<t;a++)n[a-1]=arguments[a];for(let t=0,a=this.events[e]||[],l=a.length;t<l;t++)a[t](...n)},events:{},on(e,t){var n;return((n=this.events)[e]||(n[e]=[])).push(t),()=>{var n;this.events[e]=null===(n=this.events[e])||void 0===n?void 0:n.filter((e=>t!==e))}}});const p="com.mendix.widgets.web.plugin.externalEvents";class v{constructor(){h(this,"channels",void 0),h(this,"id",Math.random().toString().slice(2)),this.channels=new Map}disposeChannel(e){const t=this.channels.get(e);return t&&(t.events={}),this.channels.delete(e)}getChannel(e){let t=this.channels.get(e);return t||(t=f(),this.channels.set(e,t),t)}emit(e,t){for(var n,a=arguments.length,l=new Array(a>2?a-2:0),r=2;r<a;r++)l[r-2]=arguments[r];null===(n=this.channels.get(e))||void 0===n||n.emit(t,...l)}subscribe(e,t,n){return this.getChannel(e).on(t,n),()=>this.unsubscribe(e,t,n)}unsubscribe(e,t,n){const a=this.channels.get(e);if(!a)return;const l=a.events[t];l&&(a.events[t]=l.filter((e=>e!==n)));0===Object.values(a.events).flat().reduce(((e,t)=>t?e+1:e),0)&&this.disposeChannel(e)}}function m(){var e,t;return null!==(t=(e=window)[p])&&void 0!==t?t:e[p]=function(){if(Object.prototype.hasOwnProperty.call(window,p))throw new Error("Widget plugin external events: plugin already initialized!");return new v}()}function g(t,n,a){e.useEffect((()=>{if(void 0!==t)return m().subscribe(t,n,a)}),[t,n])}class b{constructor(e){var t;h(this,"clearTimers",void 0),h(this,"valueHelper",void 0),h(this,"filterListener",void 0),h(this,"stateListener",void 0),h(this,"_value",void 0),h(this,"state",void 0),h(this,"dispatchOnMounted",void 0),this._value=e.defaultValue,this.filterListener=e.onFilterChange,this.dispatchOnMounted=e.dispatchOnMounted,this.valueHelper=e.valueHelper,this.state={inputValue:this.valueHelper.toString(e.defaultValue),filterFn:e.defaultFilter},[this.onInputChange,this.clearTimers]=((e,t)=>{let n=null;const a=()=>{null!==n&&(clearTimeout(n),n=null)};return[function(){for(var l=arguments.length,r=new Array(l),i=0;i<l;i++)r[i]=arguments[i];a(),n=setTimeout((()=>e(...r)),t)},a]})(this.onInputChange.bind(this),null!==(t=e.delay)&&void 0!==t?t:500)}addStateChangeListener(e){this.stateListener=e}dispose(){this.clearTimers(),this.stateListener=void 0,this.filterListener=void 0}set(e,t){return this.state[e]!==t&&(this.state[e]=t,this.dispatchState({...this.state}),!0)}setInputValue(e){this.set("inputValue",e)&&this.onInputChange()}setFilterFn(e){this.set("filterFn",e)&&this.onFilterChange()}dangerous_setValueAndDoNotDispatch(e){return!this.valueHelper.equals(this._value,e)&&(this._value=e,this.set("inputValue",this.valueHelper.toString(e)),!0)}reset(){this.dangerous_setValueAndDoNotDispatch(void 0)&&this.dispatchValue()}setupEffect(){return this.dispatchOnMounted&&this.dispatchValue(),()=>this.dispose()}dispatchState(e){var t;null===(t=this.stateListener)||void 0===t||t.call(this,e)}dispatchValue(){var e;null===(e=this.filterListener)||void 0===e||e.call(this,this._value,this.state.filterFn)}onInputChange(){const e=this.valueHelper.fromString(this.state.inputValue);this.valueHelper.equals(this._value,e)||(this._value=e,this.dispatchValue())}onFilterChange(){this.dispatchValue()}}function y(t){const n=function(t){const n=e.useRef(t);return e.useEffect((()=>{n.current=t})),e.useCallback((function(){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a];return n.current&&n.current.apply(void 0,t)}),[])}(t.onFilterChange),a=e.useMemo((()=>new b({...t,onFilterChange:n})),[]),[l,r]=e.useState((()=>(a.addStateChangeListener((e=>r(e))),a.state))),i=e.useMemo((()=>({setInputValue:e=>a.setInputValue(e),setFilterFn:e=>a.setFilterFn(e),dangerous_setValueAndDoNotDispatch:e=>a.dangerous_setValueAndDoNotDispatch(e),reset:()=>a.reset()})),[]);return e.useEffect((()=>a.setupEffect()),[]),[l,i]}function E(t){var n,a;const l=e.useRef(null),r=null!==(n=t.inputDisabled)&&void 0!==n?n:()=>!1,[i,{setFilterFn:s,setInputValue:u,reset:o,dangerous_setValueAndDoNotDispatch:c}]=y({onFilterChange:t.onChange,defaultValue:t.value,defaultFilter:t.defaultFilter,dispatchOnMounted:void 0!==t.value,delay:t.changeDelay,valueHelper:t.valueHelper});return e.useEffect((()=>{c(t.value)}),[t.value]),function(t){let{widgetName:n,parentChannelName:a,listener:l}=t;const{current:r}=e.useRef(l);g(n,d.reset.value,r),g(a,d.reset.value,r)}({widgetName:t.name,parentChannelName:null!==(a=t.parentChannelName)&&void 0!==a?a:void 0,listener:o}),{defaultFilter:t.defaultFilter,filters:t.filters,inputType:t.inputType,inputRef:l,inputValue:i.inputValue,inputDisabled:r(i.filterFn),onFilterChange:e.useCallback((e=>{var t;s(e),null===(t=l.current)||void 0===t||t.focus()}),[]),onInputChange:e.useCallback((e=>u(e.target.value)),[])}}const C={fromString:e=>{try{return new r.default(e)}catch{return}},toString:e=>e?e.toString():"",equals:(e,t)=>e instanceof r.default&&t instanceof r.default?e.eq(t):e===t},w=Object.entries({greater:"Greater than",greaterEqual:"Greater than or equal",equal:"Equal",notEqual:"Not equal",smaller:"Smaller than",smallerEqual:"Smaller than or equal",empty:"Empty",notEmpty:"Not empty"}).map((e=>{let[t,n]=e;return{value:t,label:n}}));function N(t){const{defaultFilter:n,value:a,onChange:l,parentChannelName:r,changeDelay:i,...s}=t,u=E({name:s.name,parentChannelName:r,inputType:"number",inputDisabled:e=>"empty"===e||"notEmpty"===e,changeDelay:i,defaultFilter:n,filters:w,value:a,onChange:l,valueHelper:C});return e.createElement(c,{...s,...u})}const F=t=>{let{className:n,bootstrapStyle:a,children:l,role:r}=t;return e.Children.count(l)>0?e.createElement("div",{className:s("alert alert-".concat(a),n),role:r},l):null};var D;F.displayName="Alert",function(e){e.STRING="string",e.NUMBER="number",e.ENUMERATION="enum",e.DATE="date",e.ASSOCIATION="association"}(D||(D={}));const S="com.mendix.widgets.web.filterable.filterContext";function q(e){if(e&&1===e.length){const[n]=e;let a="equal";switch(n.type){case">":a="greater";break;case">=":a="greaterEqual";break;case"=":a="equal";break;case"!=":a="notEqual";break;case"<":a="smaller";break;case"<=":a="smallerEqual"}if(n.value instanceof t.Big)return{type:a,value:n.value}}}function A(e){if(e)return Object.keys(e).map((t=>e[t])).filter((e=>e.type.match(/AutoNumber|Decimal|Integer|Long/)))}return function(t){var a;const l=e.useRef("NumberFilter".concat(function(){const e="com.mendix.widgets.web.UUID";return window[e]||(window[e]=1),window[e]++}())),{current:r}=e.useRef(null===(a=t.defaultValue)||void 0===a?void 0:a.value),i=window[S],s=e.createElement(F,{bootstrapStyle:"danger"},"The Number filter widget must be placed inside the header of the Data grid 2.0 or Gallery widget."),u=e.createElement(F,{bootstrapStyle:"danger"},'The Number filter widget can\'t be used with the filters options you have selected. It requires a "Autonumber, Decimal, Integer or Long" attribute to be selected.');return(null==i?void 0:i.Consumer)?e.createElement(i.Consumer,null,(a=>{var i,o,c,d,h,f,p,v;if(!a||!a.filterDispatcher||!a.singleAttribute&&!a.multipleAttributes)return s;const{filterDispatcher:m,singleAttribute:g,multipleAttributes:b,singleInitialFilter:y,multipleInitialFilters:E}=a,C=[...g?[g]:[],...b&&null!==(i=A(b))&&void 0!==i?i:[]];if(0===C.length)return b?u:s;const w=q(y||(null==E?void 0:E[C[0].id])),S=(I=C[0].type)&&!I.match(/AutoNumber|Decimal|Integer|Long/)?"The attribute type being used for Number filter is not 'Autonumber, Decimal, Integer or Long'":null;var I;return S?e.createElement(F,{bootstrapStyle:"danger"},S):"loading"===(null===(o=t.defaultValue)||void 0===o?void 0:o.status)?null:e.createElement(N,{name:t.name,parentChannelName:null!==(c=a.eventsChannelName)&&void 0!==c?c:null,adjustable:t.adjustable,className:t.class,defaultFilter:null!==(d=null==w?void 0:w.type)&&void 0!==d?d:t.defaultFilter,value:null!==(h=null==w?void 0:w.value)&&void 0!==h?h:r,changeDelay:t.delay,id:l.current,placeholder:null===(f=t.placeholder)||void 0===f?void 0:f.value,screenReaderButtonCaption:null===(p=t.screenReaderButtonCaption)||void 0===p?void 0:p.value,screenReaderInputCaption:null===(v=t.screenReaderInputCaption)||void 0===v?void 0:v.value,styles:t.style,tabIndex:t.tabIndex,onChange:(e,a)=>{var l,r;null===(l=t.valueAttribute)||void 0===l||l.setValue(e),null===(r=t.onChange)||void 0===r||r.execute();const i=null==C?void 0:C.map((t=>function(e,t,a){if(!e||!e.filterable||"empty"!==a&&"notEmpty"!==a&&!t)return;const l={greater:n.greaterThan,greaterEqual:n.greaterThanOrEqual,equal:n.equals,notEqual:n.notEqual,smaller:n.lessThan,smallerEqual:n.lessThanOrEqual,empty:n.equals,notEmpty:n.notEqual};return l[a](n.attribute(e.id),n.literal("empty"===a||"notEmpty"===a?void 0:t))}(t,e,a))).filter((e=>void 0!==e));m({getFilterCondition:()=>i&&i.length>1?n.or(...i):null==i?void 0:i[0],filterType:D.NUMBER})}})})):s}}));
